<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bitrix24 Companies Fetcher</title>
  <link rel="stylesheet" href="/public/css/styles.css">
  <script src="https://unpkg.com/vue@3/dist/vue.global.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>
  <script src="/public/js/app.js" defer></script>
</head>
<body>
  {% verbatim %}
  <div id="app">
    <h2>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–ø–∞–Ω–∏–π –∏–∑ –ë–∏—Ç—Ä–∏–∫—Å24</h2>

    <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
      <div style="flex: 1; min-width: 200px;">
        <input
          class="input-url"
          :class="{'error-border': error && (error.includes('URL') || error.includes('–¥–æ–º–µ–Ω'))}"
          v-model="webhookUrl"
          placeholder="–ü—Ä–∏–º–µ—Ä—ã:
‚Ä¢ https://–≤–∞—à.bitrix24.ru/rest/123/—Ç–æ–∫–µ–Ω/crm.company.list.json
‚Ä¢ https://yoow.bitrix24.by/rest/456/—Ç–æ–∫–µ–Ω/crm.company.list.json
‚Ä¢ https://corporate.bitrix24.kz/rest/789/—Ç–æ–∫–µ–Ω/crm.company.list.json"
          style="font-family: monospace; font-size: 13px; line-height: 1.4;"
          @input="error = ''"
        />
      </div>
      <button @click="fetchCompanies" :disabled="loading" style="width: auto; padding: 10px 15px; white-space: nowrap;">
        {{ loading ? '–ó–∞–≥—Ä—É–∑–∫–∞...' : '–ü–æ–ª—É—á–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏–∏' }}
      </button>
      <button @click="clearCache" v-if="companies.length > 0 || isFromCache" style="width: auto; padding: 10px 15px; background: var(--warning); color: var(--warning-text); white-space: nowrap;">
        –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à
      </button>
    </div>

    <div v-if="error" class="error" v-html="formattedError"></div>
    <div v-if="loading" class="loading">{{ progressMessage || '–ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É...' }}</div>
    <div v-if="isFromCache && !loading" class="cache-indicator">
      ‚è±Ô∏è –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –∫—ç—à–∞ (–∞–∫—Ç—É–∞–ª—å–Ω—ã 10 –º–∏–Ω—É—Ç)
    </div>
    
    <button 
      v-if="companies.length > 0 && !loading"
      @click="downloadExcel"
      style="background: var(--success); margin-top: 6px; width: auto; padding: 8px 15px; color: white;"
    >
      –°–∫–∞—á–∞—Ç—å Excel ({{ companies.length }} –∫–æ–º–ø–∞–Ω–∏–π)
    </button>

    <!-- –ï–¥–∏–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è -->
    <div v-if="companies.length > 0 && !loading" style="display: flex; gap: 10px; margin: 15px 0; align-items: center; flex-wrap: wrap;">
      <!-- –ü–æ–ª–µ –ø–æ–∏—Å–∫–∞ -->
      <div style="flex: 1; min-width: 150px;">
        <input
          v-model="searchQuery"
          placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..."
          style="width: 100%; height: 40px; padding: 0 12px; background: var(--warning-bg); border: 1px solid var(--border-input); border-radius: 0; font-size: 14px; box-sizing: border-box;"
        />
      </div>
      
      <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –í–°–ï–ì–î–ê –≤–∏–¥–µ–Ω, –¥–∞–∂–µ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö -->
      <div class="view-toggle">
        <button 
          @click="viewMode = 'cards'"
          :class="{ active: viewMode === 'cards' }"
          title="–†–µ–∂–∏–º –∫–∞—Ä—Ç–æ—á–µ–∫"
        >
          üìá
        </button>
        <button 
          @click="viewMode = 'table'"
          :class="{ active: viewMode === 'table' }"
          title="–†–µ–∂–∏–º —Ç–∞–±–ª–∏—Ü—ã"
        >
          üìã
        </button>
      </div>
    </div>

    <div v-if="total > 0" class="summary">
      –í—Å–µ–≥–æ –∫–æ–º–ø–∞–Ω–∏–π: {{ total }} 
      <span v-if="searchQuery">| –ù–∞–π–¥–µ–Ω–æ: {{ filteredCompanies.length }}</span>
      <span v-if="isFromCache"> (–∏–∑ –∫—ç—à–∞)</span>
      | –°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ currentPage }} –∏–∑ {{ totalPages }}
    </div>

    <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞ -->
    <div v-if="pagedCompanies.length" style="margin-top: 15px;">
      <!-- –†–µ–∂–∏–º –∫–∞—Ä—Ç–æ—á–µ–∫ -->
      <div v-if="viewMode === 'cards'">
        <div v-for="company in pagedCompanies" :key="company.ID" class="company">
          <div class="title">{{ company.TITLE || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è' }}</div>
          <div v-if="getFirstValue(company.PHONE)" class="detail">üìû {{ getFirstValue(company.PHONE) }}</div>
          <div v-if="getFirstValue(company.EMAIL)" class="detail">‚úâÔ∏è {{ getFirstValue(company.EMAIL) }}</div>
        </div>
      </div>

      <!-- –†–µ–∂–∏–º —Ç–∞–±–ª–∏—Ü—ã -->
      <div v-else class="table-container">
        <table class="companies-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏</th>
              <th class="desktop-only">–¢–µ–ª–µ—Ñ–æ–Ω</th>
              <th class="desktop-only">Email</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="company in pagedCompanies" :key="company.ID">
              <td>{{ company.ID }}</td>
              <td>{{ company.TITLE || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è' }}</td>
              <td class="desktop-only">{{ getFirstValue(company.PHONE) }}</td>
              <td class="desktop-only">{{ getFirstValue(company.EMAIL) }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    <div v-if="totalPages > 1" class="pagination">
      <button 
        @click="currentPage = Math.max(1, currentPage - 1)"
        :disabled="currentPage === 1"
      >
        ‚Üê
      </button>

      <button
        v-for="page in totalPages"
        :key="page"
        @click="currentPage = page"
        :class="{ active: page === currentPage }"
      >
        {{ page }}
      </button>

      <button
        @click="currentPage = Math.min(totalPages, currentPage + 1)"
        :disabled="currentPage === totalPages"
      >
        ‚Üí
      </button>
    </div>
  </div>
  {% endverbatim %}
</body>
</html>