<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bitrix24 Companies Fetcher</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background: #f5f5f5;
      margin: 0 auto;
      max-width: 900px;
      color: #333;
    }

    h2 {
      margin-top: 0;
      font-size: 20px;
      color: #333;
    }

    /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ */
    input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 0;
      background: white;
      font-size: 14px;
      box-sizing: border-box;
      margin-bottom: 10px;
    }

    /* –ö–Ω–æ–ø–∫–∞ */
    button {
      width: 100%;
      padding: 10px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 0;
      cursor: pointer;
      font-size: 14px;
      margin-bottom: 10px;
      font-weight: 500;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    /* –û—à–∏–±–∫–∏ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ */
    .error {
      color: #dc3545;
      margin: 10px 0;
      font-size: 14px;
      line-height: 1.4;
    }
    .loading {
      color: #007bff;
      margin: 10px 0;
      font-size: 14px;
      line-height: 1.4;
    }

    /* –°—É–º–º–∞—Ä–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */
    .summary {
      margin: 10px 0;
      font-weight: bold;
      font-size: 14px;
      color: #333;
    }

    /* –ö–∞—Ä—Ç–æ—á–∫–∞ –∫–æ–º–ø–∞–Ω–∏–∏ */
    .company {
      background: white;
      padding: 12px;
      border: 1px solid #e0e0e0;
      margin: 4px 0;
      font-size: 14px;
      line-height: 1.4;
    }
    .company .title {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 14px;
    }
    .company .detail {
      font-weight: normal;
      font-size: 12px;
      color: #666;
      margin: 2px 0;
    }

    /* –ü–∞–≥–∏–Ω–∞—Ü–∏—è ‚Äî –°–¢–†–û–ì–û –í –û–î–ù–£ –°–¢–†–û–ö–£ */
    .pagination {
      display: flex;
      gap: 4px;
      margin-top: 15px;
      overflow-x: auto;
      padding-bottom: 5px;
      scrollbar-width: thin;
      -ms-overflow-style: -ms-autohiding-scrollbar;
    }
    .pagination::-webkit-scrollbar {
      height: 6px;
    }
    .pagination::-webkit-scrollbar-thumb {
      background: #ccc;
      border-radius: 3px;
    }

    /* –ö–Ω–æ–ø–∫–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ */
    .pagination button {
      padding: 6px 10px;
      background: #f8f8f8;
      border: 1px solid #ddd;
      border-radius: 3px;
      cursor: pointer;
      min-width: 32px;
      text-align: center;
      font-size: 13px;
      font-weight: 500;
      color: #555;
      transition: none;
    }
    .pagination button:hover:not(:disabled) {
      background: #e9ecef;
      color: #333;
    }
    .pagination button.active {
      background: #007bff;
      color: white;
      border-color: #007bff;
      font-weight: 600;
    }
    .pagination button:disabled {
      opacity: 1;
      color: #999;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div id="app">
    <h2>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–ø–∞–Ω–∏–π –∏–∑ –ë–∏—Ç—Ä–∏–∫—Å24</h2>

    <input
      v-model="webhookUrl"
      placeholder="–í—Å—Ç–∞–≤—å—Ç–µ URL –≤–µ–±—Ö—É–∫–∞ (crm.company.list.json)"
    />
    <button @click="fetchCompanies" :disabled="loading">
      {{ loading ? '–ó–∞–≥—Ä—É–∑–∫–∞...' : '–ü–æ–ª—É—á–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏–∏' }}
    </button>

    <div v-if="error" class="error">{{ error }}</div>
    <div v-if="loading" class="loading">–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ... —ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è (–¥–æ 10 —Ç—ã—Å. –∫–æ–º–ø–∞–Ω–∏–π).</div>
    
    <div v-if="total > 0" class="summary">
      –í—Å–µ–≥–æ –∫–æ–º–ø–∞–Ω–∏–π: {{ total }} | –°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ currentPage }} –∏–∑ {{ totalPages }}
    </div>

    <div v-if="pagedCompanies.length" style="margin-top: 15px;">
      <div v-for="company in pagedCompanies" :key="company.ID" class="company">
        <div class="title">{{ company.TITLE || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è' }}</div>
        <div v-if="getFirstValue(company.PHONE)" class="detail">üìû {{ getFirstValue(company.PHONE) }}</div>
        <div v-if="getFirstValue(company.EMAIL)" class="detail">‚úâÔ∏è {{ getFirstValue(company.EMAIL) }}</div>
      </div>
    </div>

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è ‚Äî –í–°–ï –°–¢–†–ê–ù–ò–¶–´ –í –û–î–ù–£ –°–¢–†–û–ö–£ -->
    <div v-if="totalPages > 1" class="pagination">
      <button 
        @click="currentPage = Math.max(1, currentPage - 1)"
        :disabled="currentPage === 1"
      >
        ‚Üê
      </button>

      <button
        v-for="page in totalPages"
        :key="page"
        @click="currentPage = page"
        :class="{ active: page === currentPage }"
      >
        {{ page }}
      </button>

      <button
        @click="currentPage = Math.min(totalPages, currentPage + 1)"
        :disabled="currentPage === totalPages"
      >
        ‚Üí
      </button>
    </div>
  </div>

  <script>
    const { createApp, ref, computed, watch } = Vue;

    createApp({
      setup() {
        const webhookUrl = ref('');
        const companies = ref([]);
        const total = ref(0);
        const loading = ref(false);
        const error = ref('');
        const currentPage = ref(1);
        const itemsPerPage = 50;

        watch(companies, () => {
          currentPage.value = 1;
        });

        const totalPages = computed(() => {
          return total.value > 0 ? Math.ceil(total.value / itemsPerPage) : 0;
        });

        const pagedCompanies = computed(() => {
          const start = (currentPage.value - 1) * itemsPerPage;
          return companies.value.slice(start, start + itemsPerPage);
        });

        const getFirstValue = (field) => {
          if (!field) return '';
          if (Array.isArray(field) && field.length > 0) {
            return field[0].VALUE || '';
          }
          return field;
        };

        const fetchCompanies = async () => {
          error.value = '';
          companies.value = [];
          total.value = 0;
          loading.value = true;

          try {
            const res = await fetch('api.php', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ webhookUrl: webhookUrl.value })
            });

            const data = await res.json();

            if (data.error) {
              error.value = data.error;
            } else {
              companies.value = data.companies || [];
              total.value = data.total || 0;
            }
          } catch (err) {
            error.value = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + err.message;
          } finally {
            loading.value = false;
          }
        };

        return {
          webhookUrl,
          fetchCompanies,
          companies,
          total,
          loading,
          error,
          currentPage,
          totalPages,
          pagedCompanies,
          getFirstValue
        };
      }
    }).mount('#app');
  </script>
</body>
</html>